---
name: Build
concurrency:
  group: ${{ github.workflow }}-${{ github.event.number }}-${{ github.event.ref }}
  cancel-in-progress: true

# Adapted from https://github.com/matplotlib/matplotlib/blob/main/.github/workflows/nightlies.yml
# and https://cibuildwheel.pypa.io/en/stable/setup/#github-actions

# 1. Move as much as possible to pyproject.toml instead of using env vars
# 2. Use native compiling for macOS via -15-intel and -14 (arm) runners
# 3. Use native compiling for aarch64 using public beta runner
#    https://github.blog/changelog/2025-01-16-linux-arm64-hosted-runners-now-available-for-free-in-public-repositories-public-preview/
# 4. On pushes, build and test all wheels and push as release artifacts (in
#    draft mode for main branch pushes).
# 5. On scheduled runs, build and test all wheels against
#    scientific-python-nightly-wheels NumPy dev, then upload the resulting wheels there.
# 6. On PRs, build against NumPy dev if [pip-pre] is in the commit message.

on:
  # Run daily at 1:23 UTC to upload nightly wheels to Anaconda Cloud
  schedule:
    - cron: '23 1 * * *'
  # Run on demand with workflow dispatch
  workflow_dispatch:
  # Run on all PRs
  pull_request:
  # Run on tags
  push:
    branches:
      - master
    tags:
      - '*'

permissions:
  actions: read

jobs:
  build_sdist:
    name: Build source distribution
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repo
      uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      with:
        persist-credentials: false
    - uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405 # v6.2.0
      with:
        python-version: 3.13
    - name: Build sdist
      run: |
        pipx run build --sdist
        pipx run twine check --strict dist/*
    - name: Upload sdist
      uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
      with:
        name: sdist
        path: dist/*.tar.gz

  build_wheels:
    name: 'Wheels: ${{ matrix.os }} ${{ matrix.arch }}'
    runs-on: ${{ matrix.os }}
    continue-on-error: true
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            arch: x86_64
          - os: ubuntu-24.04-arm
            arch: aarch64
          - os: windows-latest
            arch: AMD64
          - os: windows-11-arm
            arch: ARM64
          - os: macos-14
            arch: arm64
          - os: macos-15-intel
            arch: x86_64
          - os: ubuntu-24.04-ppc64le
            arch: ppc64le
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0  # get the non-merge commit for PRs
          persist-credentials: false

      # Get HDF5 outside of cibuildwheel so that we can set env vars via GITHUB_ENV
      # inside the HDF5-getting scripts and have them be in effect for the
      # cibuildwheel step.

      # Windows HDF5
      - name: Cache built HDF5 (Windows)
        uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v4.2.4  # zizmor: ignore[cache-poisoning] cache not used when uploading wheels
        with:
          key: ${{ matrix.os }}-${{ matrix.arch }}-0-${{ hashFiles('ci/cibw_before_all_windows.sh', 'ci/get_hdf5_win.py') }}
          path: cache/hdf5
        # When preparing to upload a release, always build HDF5 to avoid potential
        # cache-poisoning attacks.
        if: ${{ runner.os == 'Windows' && github.ref_type != 'tag' && github.event_name != 'schedule' }}
      - uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405 # v6.2.0
        with:
          python-version: 3.12
        if: runner.os == 'Windows'
      - run: bash ./ci/cibw_before_all_windows.sh "${{ github.workspace }}"
        env:
          ARCH: ${{ matrix.arch }}
        if: runner.os == 'Windows'

      # macOS HDF5
      - name: Cache built HDF5 (Mac)
        uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v4.2.4  # zizmor: ignore[cache-poisoning] cache not used when uploading wheels
        with:
          key: ${{ matrix.os }}-${{ matrix.arch }}-0-${{ hashFiles('ci/cibw_before_all_macos.sh', 'ci/get_hdf5_if_needed.sh') }}
          path: cache/hdf5
        # When preparing to upload a release, always build HDF5 to avoid potential
        # cache-poisoning attacks.
        if: ${{ runner.os == 'macOS' && github.ref_type != 'tag' && github.event_name != 'schedule' }}
      - run: bash ./ci/cibw_before_all_macos.sh "${{ github.workspace }}"
        if: runner.os == 'macOS'

      # Triage build
      - run: bash ./ci/triage_build.sh "${{ matrix.arch }}" "${{ github.event.pull_request.head.sha || github.sha }}"

      # Now actually build the wheels
      - uses: pypa/cibuildwheel@298ed2fb2c105540f5ed055e8a6ad78d82dd3a7e # v3.3.1
        if: matrix.arch != 'ppc64le'
      
      - name: Setup Python and system dependencies (ppc64le)
        if: matrix.arch == 'ppc64le'
        run: |
          sudo apt-get update
          sudo apt-get install -y software-properties-common pkg-config
          sudo add-apt-repository ppa:deadsnakes/ppa -y
          sudo apt-get update
          sudo apt-get install -y \
            python3.11 python3.11-dev python3.11-venv \
            python3.12 python3.12-dev python3.12-venv \
            python3.13 python3.13-dev python3.13-venv \
            python3.14 python3.14-dev python3.14-venv \
            python3-pip
      
      # ------------------------------------------------------------
      # Build NumPy wheels (policy-aligned)
      #
      # NumPy support:
      # - Python 3.11 â†’ NumPy 2.4.x
      # - Python >=3.12 â†’ NumPy main (2.5+)
      # ------------------------------------------------------------
      # ppc64le builds NumPy from source because official wheels are not available.
      # This is intentionally separated from cibuildwheel to avoid repeated rebuilds.

      - name: Build NumPy wheels from source (ppc64le)
        if: matrix.arch == 'ppc64le'
        run: |
          set -euo pipefail
          mkdir -p numpy_wheels
          build_numpy () {
            local PY=$1
            local DIR=$2
            echo "ðŸ”¹ Building NumPy in $DIR for Python $PY"
            cd "$DIR"
            python$PY -m venv venv$PY
            source venv$PY/bin/activate
            pip install -U pip setuptools wheel meson ninja meson-python Cython build
            
            python -m build --wheel --no-isolation -v
            cp dist/*.whl ../numpy_wheels/
            deactivate
            rm -rf build dist .mesonpy-* _skbuild venv$PY
            cd ..
          }
          # NumPy 2.4.x for Python 3.11
          git clone --depth 1 --branch v2.4.1 --recurse-submodules https://github.com/numpy/numpy.git numpy-2.4.1
          build_numpy 3.11 numpy-2.4.1
          # NumPy main for Python >= 3.12
          git clone --depth 1 --recurse-submodules https://github.com/numpy/numpy.git numpy-main
          for PY in 3.12 3.13 3.14; do
            build_numpy $PY numpy-main
          done
      
      - name: Setup venv for h5py build
        if: matrix.arch == 'ppc64le'
        run: |
          python3.12 -m venv venv
          source venv/bin/activate
          pip install -U pip setuptools wheel cibuildwheel
      - name: Build h5py wheels using locally built NumPy (ppc64le)
        if: matrix.arch == 'ppc64le'
        run: |
          source venv/bin/activate
          cibuildwheel
        env:
          CIBW_ARCHS: ppc64le
          CIBW_BUILD: "cp311-manylinux_ppc64le cp312-manylinux_ppc64le cp313-manylinux_ppc64le cp314-manylinux_ppc64le"
          CIBW_BUILD_FRONTEND: "pip"
          CIBW_BEFORE_BUILD: |
            PYTAG=$(python -c "import sys; print(f'cp{sys.version_info.major}{sys.version_info.minor}')")
            pip install ./numpy_wheels/*${PYTAG}*.whl
          CIBW_BEFORE_TEST: |
            PYTAG=$(python -c "import sys; print(f'cp{sys.version_info.major}{sys.version_info.minor}')")
            pip install ./numpy_wheels/*${PYTAG}*.whl
          CIBW_TEST_SKIP: "cp*-*ppc64le"

      - run: python ./ci/bundle_hdf5_whl.py wheelhouse
        if: runner.os == 'Windows'

      # And upload the results
      - uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: cibw-wheels-${{ matrix.os }}-${{ strategy.job-index }}
          path: ./wheelhouse/*.whl

  check-minimal-build:
    # this job isn't meant to upload anything, it's only a sanity check
    name: Check minimal build requirements (${{ matrix.label }})
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            arch: x86_64
            cibw_before_build: pip install --only-binary ':all:' 'numpy==1.25.0' 'Cython==3.0.0' 'setuptools==77.0.1' 'pkgconfig==1.5.5'
            label: 'numpy-min'
          - os: ubuntu-latest
            arch: x86_64
            cibw_before_build: pip install --only-binary ':all:' 'numpy==2.0.0' 'Cython==3.0.0' 'setuptools==77.0.1' 'pkgconfig==1.5.5'
            label: 'cython-min + numpy 2.0'
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0  # get the non-merge commit for PRs
          persist-credentials: false

      # Triage build
      - run: bash ./ci/triage_build.sh "${{ matrix.arch }}" "${{ github.event.pull_request.head.sha || github.sha }}"

      # Now actually build the wheels
      - uses: pypa/cibuildwheel@298ed2fb2c105540f5ed055e8a6ad78d82dd3a7e # v3.3.1
        env:
          CIBW_ARCHS: ${{ matrix.arch }}
          CIBW_BUILD: "cp310-*"
          CIBW_BEFORE_BUILD: ${{ matrix.cibw_before_build }}
          CIBW_BUILD_FRONTEND: 'pip; args: --no-build-isolation'
          ONLY_MINDEPS_TESTS: "1"

  upload_artifacts:
    name: Upload build artifacts
    if: ${{ github.repository_owner == 'h5py' && (
                (github.event_name == 'push' && github.ref_type == 'tag')
                || (github.event_name == 'schedule'))
      }}
    permissions:
      contents: write
      id-token: write
    needs:
      - build_sdist
      - build_wheels
      - check-minimal-build
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash -el {0}
    steps:
      - name: Download sdist
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: sdist
          path: dist
        if: github.repository_owner == 'h5py' && github.event_name == 'push' && github.ref_type == 'tag'
      - name: Download wheels
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          pattern: cibw-wheels-*
          merge-multiple: true
          path: dist
      - run: pwd && ls -alt . && ls -alt dist/

      # If it's a scheduled run, it was built with nightly NumPy, push to scientific-python:
      - name: Upload wheels to Anaconda Cloud as nightlies
        uses: scientific-python/upload-nightly-action@5748273c71e2d8d3a61f3a11a16421c8954f9ecf # 0.6.3
        with:
          artifacts_path: dist
          anaconda_nightly_upload_token: ${{ secrets.ANACONDA_ORG_UPLOAD_TOKEN }}
        if: github.repository_owner == 'h5py' && github.event_name == 'schedule'

      # If it's a tag, create a Github release
      - name: Upload to GitHub releases
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2.5.0
        # https://github.com/softprops/action-gh-release?tab=readme-ov-file#inputs
        with:
          draft: false
          generate_release_notes: false
          files: |
            dist/*
        if: github.repository_owner == 'h5py' && github.event_name == 'push'

      # If it's a tag, publish to PyPI
      - name: Publish package distributions to PyPI
        uses: pypa/gh-action-pypi-publish@ed0c53931b1dc9bd32cbe73a98c7f6766f8a527e # v1.13.0
        if: github.repository_owner == 'h5py' && github.event_name == 'push' && github.ref_type == 'tag'
